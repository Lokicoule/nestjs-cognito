export const metadata = {
  title: 'GraphQL Integration - NestJS Cognito',
  description: 'Learn how to integrate GraphQL with NestJS-Cognito for secure, type-safe API authentication.'
}

# GraphQL Integration

The `@nestjs-cognito/graphql` package provides GraphQL-specific decorators and guards for authentication and authorization.

## Installation

<CodeGroup>
```sh {{ title: 'pnpm' }}
pnpm add @nestjs-cognito/graphql
```
```sh {{ title: 'npm' }}
npm i @nestjs-cognito/graphql
```
```sh {{ title: 'yarn' }}
yarn add @nestjs-cognito/graphql
```
</CodeGroup>

## Basic Setup

Configure the core authentication module:

```typescript
import { CognitoAuthModule } from '@nestjs-cognito/auth';

@Module({
  imports: [
    CognitoAuthModule.register({
      jwtVerifier: {
        userPoolId: 'us-east-1_xxxxxx',
        clientId: 'your-client-id'
        tokenUse: 'access',
      },
    })
  ]
})
export class AppModule {}
```

## Authentication

Protect your GraphQL operations using the `@GqlAuthentication()` decorator:

```typescript
import { GqlAuthentication } from '@nestjs-cognito/graphql';

@Resolver()
export class SecureResolver {
  @Query()
  @GqlAuthentication()
  async secureData() {
    return { message: 'This is secure data' };
  }
}
```

## Authorization

Implement role-based access control with the `@GqlAuthorization()` decorator:

```typescript
import { GqlAuthorization } from '@nestjs-cognito/graphql';

@Resolver()
export class AdminResolver {
  @Mutation()
  @GqlAuthorization(['admin'])
  async adminOperation() {
    return { success: true };
  }
}
```

## User Information

Access the authenticated user's information using the GraphQL Cognito decorators:

### Generic Decorator

```typescript
import { GqlCognitoUser } from '@nestjs-cognito/graphql';
import type { CognitoJwtPayload } from '@nestjs-cognito/core';

@Resolver()
export class UserResolver {
  @Query()
  @GqlAuthentication()
  async me(@GqlCognitoUser() user: CognitoJwtPayload) {
    return {
      id: user.sub,
      username: user.username,
      email: user.email
    };
  }
}
```

### Specialized Decorators

For better type safety, use `@GqlCognitoAccessUser` or `@GqlCognitoIdUser`:

```typescript
import { GqlCognitoIdUser, GqlCognitoAccessUser } from '@nestjs-cognito/graphql';
import type { CognitoIdTokenPayload, CognitoAccessTokenPayload } from '@nestjs-cognito/core';

@Resolver()
export class UserResolver {
  // For ID tokens
  @Query()
  @GqlAuthentication()
  async profile(@GqlCognitoIdUser() user: CognitoIdTokenPayload) {
    return {
      username: user['cognito:username'],
      email: user.email,
      groups: user['cognito:groups']
    };
  }

  // For access tokens
  @Query()
  @GqlAuthentication()
  async tokenInfo(@GqlCognitoAccessUser() token: CognitoAccessTokenPayload) {
    return {
      scope: token.scope,
      clientId: token.client_id
    };
  }
}
```

The specialized decorators validate token types at runtime and throw `CognitoTokenTypeMismatchError` if the token type doesn't match.